name: 'Docker build action'
description: 'Odyssey docker build image action'
inputs:
  image-name:
    description: "Name of the docker image, defaults to git repository name"
    required: true
    default: ${{ github.event.repository.name }}
  registry-server:
    required: true
  registry-user:
    descriptin: "Docker registry username"
    required: true
  registry-pass:
    description: "Docker registry password"
    required: true
  backfeed-repo-token:
    description: "Github token to passthrough docker build to access current repo"
    required: true
runs:
  using: "composite"
  steps:
    - id: setvars
      name: ${{github.event_name}}-${{github.event.ref }}
      shell: bash
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          VERSION=nightly
        elif [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        elif [[ $GITHUB_REF == refs/heads/* ]]; then
          VERSION=$(echo ${GITHUB_REF#refs/heads/} | sed -r 's#/+#-#g')
          if [ "${{ github.event.repository.default_branch }}" = "$VERSION" ]; then
            VERSION=latest
          fi
        elif [[ $GITHUB_REF == refs/pull/* ]]; then
          VERSION=pr-${{ github.event.number }}
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_ENV

    # checkout the repo
    - name: "Checkout GitHub Action"
      uses: actions/checkout@master
      with:
        submodules: true
        lfs: true

    - name: "Docker login"
      uses: azure/docker-login@v1
      with:
        login-server: ${{ inputs.registry-server }}
        username: ${{ inputs.registry-user }}
        password: ${{ inputs.registry-pass }}

    - name: "Build and push image"
      env:
        IMAGE: ${{ inputs.registry-server }}/${{ inputs.image-name }}
      run: |
        docker build --build-arg GITHUB_TOKEN=${{ inputs.backfeed-repo-token }} -f Dockerfile . -t ${IMAGE}:${{ github.sha }} -t ${IMAGE}:${VERSION}
        docker push ${IMAGE}:${{ github.sha }}
        docker push ${IMAGE}:${VERSION}
      shell: bash

