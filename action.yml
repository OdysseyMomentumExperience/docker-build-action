name: 'Docker build action'
description: 'Odyssey docker build image action'
inputs:
  image-name:
    description: "Name of the docker image, defaults to git repository name"
    required: true
    default: ${{ github.event.repository.name }}
  registry-server:
    description: "Docker registry location/URL"
    required: true
  registry-user:
    description: "Docker registry username"
    required: true
  registry-pass:
    description: "Docker registry password"
    required: true
  ops-repo-token:
    description: "Github token to access operations repo"
    required: true
  backfeed-repo-token:
    description: "Github token to passthrough docker build to access current repo"
    required: false
outputs:
  version:
    description: "Version string generated for the image."
    value: ${{ steps.setvars.outputs.version }}
runs:
  using: "composite"
  steps:
    - id: setvars
      name: ${{github.event_name}}-${{github.event.ref }}
      shell: bash
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          VERSION=nightly
        elif [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        elif [[ $GITHUB_REF == refs/heads/* ]]; then
          VERSION=$(echo ${GITHUB_REF#refs/heads/} | sed -r 's#/+#-#g')
          if [ "${{ github.event.repository.default_branch }}" = "$VERSION" ]; then
            VERSION=latest
          fi
        elif [[ $GITHUB_REF == refs/pull/* ]]; then
          VERSION=pr-${{ github.event.number }}
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
        echo "::set-output name=version::$(echo $VERSION)"

    # checkout the repo
    - name: "Checkout GitHub Action"
      uses: actions/checkout@master
      with:
        submodules: true
        lfs: true

    - name: "Docker login"
      uses: azure/docker-login@v1
      with:
        login-server: ${{ inputs.registry-server }}
        username: ${{ inputs.registry-user }}
        password: ${{ inputs.registry-pass }}

    - name: "Build and push image"
      env:
        IMAGE: ${{ inputs.registry-server }}/${{ inputs.image-name }}
      run: |
        docker build --build-arg GITHUB_TOKEN=${{ inputs.backfeed-repo-token }} -f Dockerfile . -t ${IMAGE}:${{ github.sha }} -t ${IMAGE}:${VERSION}
        docker push ${IMAGE}:${{ github.sha }}
        docker push ${IMAGE}:${VERSION}
      shell: bash

    - uses: ChristopherHX/conditional@3fce4b7a3171a839b482306f9fd3aba0c2112a24
      name: "Conditional dispatch"
      with:
        if: ${{startsWith(github.ref, 'refs/tags/')}}
        step: |
          name: Dispatch to Operations
          uses: peter-evans/repository-dispatch@v1
          with:
            token: ${{ inputs.ops-repo-token }}
            repository: OdysseyMomentumExperience/Operations
            event-type: make-acc-pr
            client-payload: '{"name": "${{ inputs.image-name }}", "version": "${{ steps.setvars.outputs.version }}", "actor": "${{ github.event.actor.login }}"}'

    - uses: ChristopherHX/conditional@3fce4b7a3171a839b482306f9fd3aba0c2112a24
      name: "!Conditional"
      with:
        if: ${{startsWith(github.ref, 'refs/tags/') != true}}
        step: |
          shell: bash
          run: |
            echo "NOT dispatching to operations:"
            echo '{"name": "${{ inputs.image-name }}", "version": "${{ steps.setvars.outputs.version }}", "actor": "${{ github.event.actor.login }}"}'
